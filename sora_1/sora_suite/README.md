# Sora Suite — контрольный центр пайплайна Sora

Sora Suite управляет всем циклом подготовки роликов: генерация изображений через Google AI Studio, отправка промптов в Sora, скачивание, блюр, склейка, автопостинг на YouTube и TikTok, уведомления в Telegram и сервисные операции. Интерфейс написан на PyQt6 и поддерживает Windows, macOS и Linux.

## Содержание
- [Что делает приложение](#что-делает-приложение)
- [Установка и обновление](#установка-и-обновление)
- [Секреты и учётные данные](#секреты-и-учётные-данные)
- [Запуск и базовый сценарий](#запуск-и-базовый-сценарий)
- [Навигация по интерфейсу](#навигация-по-интерфейсу)
- [Промпты, названия и сценарии](#промпты-названия-и-сценарии)
- [Генерация картинок Google AI Studio](#генерация-картинок-google-ai-studio)
- [Автопостинг YouTube](#автопостинг-youtube)
- [Автопостинг TikTok](#автопостинг-tiktok)
- [Телеграм-уведомления](#телеграм-уведомления)
- [Chrome через DevTools Protocol](#chrome-через-devtools-protocol)
- [FFmpeg — параметры и советы](#ffmpeg--параметры-и-советы)
- [Обслуживание и обновления](#обслуживание-и-обновления)
- [Оптимизация и полезные заметки](#оптимизация-и-полезные-заметки)

## Что делает приложение
- Подхватывает текстовые промпты и image-промпты по профилям Chrome, ведёт manifest с результатами.
- Запускает пакетную генерацию изображений, переименовывает файлы последовательно и сохраняет их рядом с проектом.
- Отправляет промпты в Sora, автоматически прикладывая проверенные изображения и `video_prompt` с учётом настроек.
- Скачивает сгенерированные ролики, переименовывает, блюрит, склеивает и готовит к публикации.
- Управляет очередями YouTube и TikTok с отложенным постингом, архивами и интеграцией GitHub Actions.
- Отправляет уведомления в Telegram, ведёт историю и показывает текущий шаг в карточке «Сейчас».
- Автоматизирует обслуживание каталогов, проверку окружения и обновление из GitHub.

## Установка и обновление
### Быстрый старт
```bash
python scripts/bootstrap.py
```
Скрипт создаст виртуальное окружение, установит зависимости из `sora_suite/requirements.txt` и скачает Chromium для Playwright.

### Ручная установка
```bash
python -m venv .venv
# Windows: .venv\Scripts\activate
# macOS/Linux: source .venv/bin/activate
python -m pip install --upgrade pip
pip install -r sora_suite/requirements.txt
python -m playwright install chromium
```

### Системные зависимости
- **FFmpeg** в `PATH` (`brew install ffmpeg`, `sudo apt install ffmpeg` или официальный билд для Windows).
- **Playwright** требует `libnss3`, `libxss1`, `fonts-liberation` на Linux.
- **Qt** ставится вместе с PyQt6.

Повторный запуск `pip install -r sora_suite/requirements.txt` обновит зависимости. Для обновления приложения используйте кнопку «Обновить из GitHub» или скрипт `scripts/self_update.py`.

## Секреты и учётные данные
Создайте папку `sora_suite/secrets/` и храните приватные файлы отдельно от `app_config.yaml`:
```
sora_suite/
  secrets/
    youtube/
      channel-a/client_secret.json
    tiktok/
      main_profile.json
    telegram.txt (опционально)
```
Эти файлы выбираются в интерфейсе, а значения кэшируются в конфиге только при необходимости.

### YouTube OAuth
1. В Google Cloud Console создайте проект и OAuth-клиент типа **Desktop app**. Скачайте `client_secret.json` и положите в `sora_suite/secrets/youtube/<имя_канала>/`.
2. Во вкладке *Настройки → YouTube* выберите файл. При первом запуске авторизации откроется окно браузера; полученный `credentials.json` сохранится рядом.
3. Настройте папку с клипами, задержку, лимит и режим «Черновик / Публикация» — значения синхронизируются со вкладкой YouTube.

### TikTok Content Posting API
1. Зарегистрируйтесь на [developers.tiktok.com](https://developers.tiktok.com/), создайте приложение и включите доступ **Content Posting API**.
2. Получите `client_key` и `client_secret`, выполните OAuth и обменяйте код на `refresh_token` и `open_id` пользователя.
3. Сохраните данные в JSON:
   ```json
   {
     "client_key": "aw41...",
     "client_secret": "***",
     "open_id": "1234567890",
     "refresh_token": "rt_...",
     "access_token": "optional",
     "access_token_expires_at": "2024-07-01T10:00:00+00:00"
   }
   ```
4. На вкладке TikTok нажмите «…» чтобы выбрать файл и «Загрузить из файла» — поля заполнятся автоматически.

### Telegram
1. Создайте бота у @BotFather и получите токен.
2. Узнайте `chat_id` (команда `/start`, затем `https://api.telegram.org/botTOKEN/getUpdates`).
3. Заполните раздел *Настройки → Telegram* и нажмите «Отправить тест».

## Запуск и базовый сценарий
1. Активируйте виртуальное окружение и запустите `python sora_suite/app.py`.
2. На вкладке **Задачи** отметьте нужные этапы, нажмите «Старт выбранного» или используйте верхние кнопки сценария.
3. Карточка «Сейчас» показывает текущий шаг, цвет и таймер без полос: текст находится в подсвеченном блоке, а фон панели остаётся прозрачным.
4. История событий и справочник ошибок переехали в настройки (последние вкладки), чтобы главная страница оставалась компактной.
5. Линия статистики под статусом отображает количество файлов RAW/BLURRED/MERGED и размер очередей YouTube/TikTok.

## Навигация по интерфейсу
### Верхняя панель
- Выбор профиля Chrome и кнопка запуска браузера.
- Кнопка «⟳» автодетекта профилей в системе.
- Компактные кнопки быстрого открытия каталогов (проект, RAW, BLURRED, MERGED, generated_images) с небольшим отступом между заголовком и блоком кнопок.
- Кнопки «Старт выбранного» и «Стоп все» для сценария.

### Обзор
Отображает вкладку «Пайплайн» с чекбоксами этапов, кнопками запуска, общей статистикой и ссылками на папки. Карточка «Сейчас» расположена выше истории.

### Контент
- **Промпты Sora** — редактор `prompts_<profile>.txt` с историей отправок. Автообнаружение профилей обновляет списки одним кликом.
- **Промпты картинок** — отдельный `image_prompts.txt`. Строки обрабатываются по порядку; поддерживается JSON (`prompt`, `prompts`, `count`, `video_prompt`).
- **Названия** — менеджер `titles.txt` для переименования скачанных роликов.

### Автопостинг
Две страницы — YouTube и TikTok. Здесь управляются очереди, расписания, учётные данные и папки загрузки. В настройках вкладки «Автопостинг» отвечают за значения по умолчанию и теперь имеют такие же отступы, как «Каталоги».

### Настройки
Внутри вкладки «Настройки» размещён отдельный таб-контейнер:
1. **Каталоги** — рабочие пути и кнопки открытия.
2. **Генерация картинок** — параметры Google AI Studio.
3. **Автоген** — паузы и лимиты воркера.
4. **FFmpeg** — кодеки, блюр-пресеты и предпросмотр.
5. **Chrome** — порт CDP, бинарь и управление профилями.
6. **YouTube** — дефолты очереди, архив и лимиты.
7. **TikTok** — аналогичные настройки для очереди и GitHub Actions.
8. **Telegram** — токен, chat id и тестовое сообщение.
9. **Интерфейс** — плотность истории.
10. **Обслуживание** — очистка и обновления.
11. **Ошибки** — справочник типовых сообщений.
12. **Документация** — встроенный просмотр README.
13. **История** — полный лог (расположен последним).

Настройки сохраняются автоматически через несколько секунд после изменения или по кнопке «Применить настройки».

## Промпты, названия и сценарии
- Каждый профиль Chrome хранит отдельные файлы `prompts_<slug>.txt`, `image_prompts.txt` и `titles.txt`.
- История использованных строк помогает отслеживать, какие промпты уже отправлялись.
- В сценарии добавлена галочка «Генерация картинок» — можно сначала запустить пакет изображений, проверить результат, а затем включить шаги промптов и загрузок.
- Рекомендации перед запуском: убедитесь, что после блюра водяной знак скрыт, просмотрите сгенерированные изображения и при необходимости отредактируйте `video_prompt`.

## Генерация картинок Google AI Studio
### Настройка API и моделей
1. Получите ключ в [Google AI Studio](https://aistudio.google.com/).
2. Во вкладке *Настройки → Генерация картинок* включите генератор, введите ключ, модель и параметры (соотношение сторон, размер, MIME-тип, лимиты и папку вывода).
3. Если API возвращает ошибки `ALLOW_ALL`/`BLOCK_ALL`, оставьте поле «Генерация людей» пустым — приложение автоматически подстроится.

### Работа с image-prompts
1. Отредактируйте `image_prompts.txt` на вкладке «Промпты картинок». Можно вводить до десятка строк — воркер вызывает Google AI Studio последовательно.
2. Кнопка **«Генерация картинок (Google)»** запускает режим `GENAI_IMAGES_ONLY`: картинки сохраняются в `generated_images/`, manifest обновляется, Sora не трогается.
3. Файлы автоматически переименовываются (1.jpg, 2.jpg …) по аналогии с видео.
4. После проверки картинок нажмите **«Сохранить и запустить автоген (видео)»** — воркер прикрепит изображения, добавит `video_prompt` и отправит промпт в Sora. Чекбокс «Прикреплять изображения к заявке» в настройках позволяет пропускать медиа.

### Другие модели Google AI
Переключить модель можно в поле «Модель». Поддерживаются, например, `models/imagen-4.0-generate-001` (высокое качество), `models/imagen-3.0-fast` (быстрее, но мягче детали) и `models/imagen-3.0-lightning` (для эскизов). Учитывайте:
- не все модели поддерживают генерацию людей;
- лимиты и стоимость различаются, проверяйте квоты проекта;
- некоторые модели строже к контент-политикам и чаще возвращают `INVALID_ARGUMENT`.
Перед переключением просмотрите документацию Google AI Studio и убедитесь, что выбранная модель есть в вашем тарифе (`client.models.list()` помогает проверить доступные идентификаторы).

## Автопостинг YouTube
1. Добавьте канал и укажите папку с клипами на вкладке «YouTube» (раздел «Контент»).
2. Настройте черновик/расписание, интервал и лимит. Папка `uploaded/` открывается прямо из настроек.
3. По завершении загрузки файл перемещается в архив, статус отображается в истории и Telegram (если включён).

## Автопостинг TikTok
1. Создайте профиль, загрузите JSON с ключами или заполните поля вручную. Приложение обновит access token перед запуском.
2. Укажите папку с роликами, включите расписание или черновики. Значения по умолчанию редактируются во вкладке *Настройки → TikTok*.
3. После успешной загрузки файлы перемещаются в `uploaded_tiktok/`. Telegram уведомит о статусе.

### GitHub Actions
- В `.github/workflows/tiktok-upload.yml` подготовлен шаблон. Он ожидает секреты `TIKTOK_CLIENT_KEY`, `TIKTOK_CLIENT_SECRET`, `TIKTOK_REFRESH_TOKEN`, `TIKTOK_OPEN_ID` и параметры профиля.
- Кнопка «GitHub Actions» на вкладке TikTok вызывает `gh workflow run` с текущими значениями.

## Телеграм-уведомления
- Переключатель в настройках включает/выключает бота. При выключенных уведомлениях приложение один раз предупредит об этом в истории.
- Отправляются события запуска сценария, завершения шагов (download/blur/merge/upload), ошибки, обслуживание и обновления.

## Chrome через DevTools Protocol
Автоген и загрузчики подключаются к запущенному Chrome/Chromium через CDP.

### Как запустить браузер
```bash
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome \
  --remote-debugging-port=9222 \
  --user-data-dir=/tmp/chrome-sora
```

Любой свободный порт 1024–65535 подойдёт. В верхней панели есть кнопка автопоиска профилей и запускателя Chrome: выберите профиль, нажмите «⟳» для сканирования и «Запустить Chrome». Если нужно второе окно, укажите другой порт (например, 9333) и снова нажмите запуск.

Проверьте `http://localhost:<порт>/json/version` — ответ должен содержать `webSocketDebuggerUrl`. Если браузер уже поднят, приложение покажет подсказку «Chrome уже поднят».

## FFmpeg — параметры и советы
| Ключ | Что делает | Где менять | Комментарий |
|------|-------------|------------|-------------|
| `binary` | Путь к FFmpeg | Настройки → FFmpeg | Укажите абсолютный путь, если FFmpeg не в `PATH`. |
| `vcodec` | Видеокодек (`libx264`, `auto_hw`, `copy`) | Настройки → FFmpeg | `auto_hw` выбирает доступный аппаратный кодек; при блюре `copy` заменяется на `libx264`. |
| `crf` | Качество `libx264` (0–51) | Настройки → FFmpeg | 18–20 оптимально для TikTok/YouTube. |
| `preset` | Скорость кодирования | Настройки → FFmpeg | `veryfast` — компромисс между скоростью и качеством. |
| `format` | Контейнер (`mp4`, `mov`, `webm`) | Настройки → FFmpeg | TikTok/YouTube предпочитают `mp4`. |
| `copy_audio` | Копировать аудио без перекодирования | Настройки → FFmpeg | При несовместимом источнике приложение предложит AAC. |
| `blur_threads` | Количество параллельных FFmpeg | Настройки → FFmpeg | Выбирайте по числу ядер/ГПУ. |
| `post_chain` | Дополнительные фильтры | Настройки → FFmpeg | Выполняются после масок блюра. |
| `presets.*.zones` | Прямоугольники блюра | Настройки → FFmpeg | Таблица с предпросмотром показывает маску поверх видео. |

### Блюр водяного знака
- Исходники ищутся в папке из *Настройки → Каталоги → Источник для BLUR*. Если каталог недоступен, используется `downloads/`.
- Поддерживаются `mp4`, `mov`, `m4v`, `webm`, `mkv`. Дубликаты игнорируются.
- Перед запуском откройте предпросмотр, чтобы проверить маски. Рекомендуется просматривать каждый ролик: расположение водяного знака может отличаться.
- FFmpeg работает в несколько потоков (`blur_threads`). Ошибки выводятся в карточку «Сейчас», историю и Telegram.
- Активный пресет сохраняется автоматически.

### Автодетект водяного знака
- В разделе **Настройки → FFmpeg → Автодетект водяного знака** включите переключатель и укажите путь к шаблону. Лучше всего подходит PNG с прозрачным фоном: альфа-канал автоматически становится маской, а лишние пустые поля обрезаются. Допустимы и JPG/PNG без альфы — в этом случае сопоставление идёт по оттенкам и контрасту.
- Алгоритм подготавливает шаблон, прогоняет несколько масштабов (`scales` или диапазон `scale_min/scale_max/scale_steps`) и смешивает результаты корреляции с поиском контуров (`edge_weight`, `canny_low`, `canny_high`). Так проще набрать высокий `score` даже на шумных роликах. Для тонкой настройки доступны `blur_kernel`, `mask_threshold`, а также `score_bias`/`score_floor`/`score_z_weight` — они помогают подогнать порог под конкретный проект.
- Порог `threshold` и количество кадров `frames` задают уверенность совпадения. Если знак «прыгает» каждые ~30 секунд, увеличьте `frames` (например, до 8–10), чтобы выборка покрыла разные моменты ролика. На практике хорошо работает диапазон 8–12 равномерно выбранных кадров: этого достаточно, чтобы поймать большинство скачков без серьёзного удорожания анализа. `downscale` (0–1 — коэффициент, >1 — максимальная сторона) уменьшает кадры перед анализом и ускоряет поиск на 4K-материалах.
- Во время блюра Sora Suite равномерно выбирает кадры, объединяет совпадения в временные интервалы и строит цепочку `delogo` с `enable='between(t,start,end)'`, поэтому перемещающийся водяной знак скрывается именно тогда, когда он появляется. Если FFmpeg сообщает `Error reinitializing filters`, приложение логирует событие, отправляет уведомление и автоматически переключается на статичные зоны, рассчитанные по автодетекту.
- Найденная область не привязана к статичному пресету: прямоугольник строится из bbox детектора, автоматически расширяется на `bbox_padding` пикселей и долю `bbox_padding_pct` от ширины/высоты и при необходимости поджимается внутри кадра. Параметр `bbox_min_size` гарантирует минимальный размер (с округлением к чётным значениям), чтобы FFmpeg уверенно применял `delogo` даже для маленьких иконок.
- Если уверенных совпадений нет, приложение пишет причину в лог, историю и Telegram и возвращается к зонам пресета, чтобы FFmpeg не падал.

## Обслуживание и обновления
- Автоочистка запускается при старте, если включён флаг «Чистить при старте».
- «Размеры папок» сообщает объём RAW/BLURRED/MERGED/архивов в истории.
- Кнопки «Проверка окружения» и «Обновить из GitHub» вызывают `git fetch/pull`. Если проект запущен из сборки без `.git`, кнопки отключены и подсказывают, как обновиться вручную.
- История и ошибки доступны в настройках (последние вкладки) и не занимают место на главном экране.

## Оптимизация и полезные заметки
- Верхние кнопки занимают меньше места: блок каталога компактнее, а label отделён небольшим отступом.
- Карточка «Сейчас» получила гладкую подсветку без полос.
- Статистика кешируется: блок «Картинки» показывает количество элементов в `generated_images/manifest.json`.
- Лента событий имеет режимы плотности и полностью скрывается, оставляя только карточку «Сейчас».
- `scripts/bootstrap.py` удобно запускать после обновлений или на CI — он гарантирует актуальность Playwright и зависимостей.
- GitHub workflow `tiktok-upload.yml` работает без cookies: достаточно задать API-ключи через секреты.
- Расширяйте приложение, добавляя новые воркеры в `sora_suite/workers/` и подключая их в разделе «Задачи».

